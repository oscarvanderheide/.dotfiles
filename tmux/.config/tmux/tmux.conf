# ============================================================================
# BASIC SETTINGS
# ============================================================================

# Start windows and panes at 1, not 0 (easier to reach on keyboard)
set -g base-index 1
set -g pane-base-index 1
set-window-option -g pane-base-index 1
set-option -g renumber-windows on

# Increase scrollback buffer
set-option -g history-limit 50000

# Auto-rename windows based on current directory
set-option -g status-interval 1
set-option -g automatic-rename on
set-option -g automatic-rename-format '#{b:pane_current_path}'

# Mouse support (toggle with prefix + m)
set-option -g mouse on
bind-key m set-option -g mouse

# ============================================================================
# TECHNICAL STUFF (colors, key handling, etc.)
# ============================================================================

# Fix colors to show true color in terminal
set -g default-terminal "tmux-256color"
set-option -sa terminal-overrides ",xterm*:Tc"
set -ag terminal-overrides ",xterm-kitty:Tc"

# Faster escape time - prevents delay when pressing Esc in vim/nvim
set -sg escape-time 10

# Enable extended key support (allows apps to distinguish Cmd from Ctrl, etc.)
set-option -g xterm-keys on
set -s extended-keys on
set -as terminal-features 'xterm*:extkeys'

# Enable focus events so apps know when pane gains/loses focus
set -g focus-events on

# Allow repeatable commands after prefix (500ms window)
set-option -g repeat-time 500

# ============================================================================
# APPEARANCE & THEME
# ============================================================================

# Plugins for theming
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'catppuccin/tmux#v2.1.2'
set -g @catppuccin_flavor 'mocha'
set -g @plugin 'sainnhe/tmux-fzf'
set -g @plugin 'vaaleyard/tmux-dotbar'

# Status bar configuration
set -g status-position top
set -g status-right-length 100
set -g status-left-length 100
set -g status-left ""
set -g status-right "#{E:@catppuccin_status_application}"
set -ag status-right "#{E:@catppuccin_status_session}"

# Pane border styling (set after TPM to override theme defaults)
set -g pane-border-style "fg=colour243,bg=default"
set -g pane-active-border-style "fg=colour243,bg=default"

# Flash effect when changing panes (visual feedback)
set-hook -g pane-focus-in "select-pane -P bg=#434C5E; run 'sleep 0.1'; select-pane -P bg=default"

# ============================================================================
# KEYBINDS - UTILITY
# ============================================================================

# Reload config easily
bind-key r source-file ~/.config/tmux/tmux.conf \; display-message "Config reloaded..."

# Kill without confirmation
bind-key & kill-window
bind-key x kill-pane

# ============================================================================
# KEYBINDS - PANE MANAGEMENT
# ============================================================================

# Split panes (opens in current directory)
bind-key \\ split-window -h -c '#{pane_current_path}'
bind-key - split-window -v -c '#{pane_current_path}'
bind -n M-\| split-window -h -c '#{pane_current_path}'
bind -n M-_ split-window -v -c '#{pane_current_path}'

# Navigate panes (prefix + h/l or Cmd+[/])
bind-key -r h select-pane -t :.-
bind-key -r l select-pane -t :.+
bind -n M-H select-pane -t :.- \; select-pane -P bg=#434C5E \; run 'sleep 0.1' \; select-pane -P bg=default
bind -n M-L select-pane -t :.+ \; select-pane -P bg=#434C5E \; run 'sleep 0.1' \; select-pane -P bg=default

# ============================================================================
# KEYBINDS - WINDOW MANAGEMENT
# ============================================================================

# Create/close windows
bind -n M-t new-window -c "#{pane_current_path}"
bind -n M-w kill-pane

# Navigate windows
bind -n M-< previous-window
bind -n M-> next-window

# ============================================================================
# KEYBINDS - SESSION MANAGEMENT
# ============================================================================

# Session switcher with fzf (Ctrl+j)
bind C-j display-popup -E "tmux list-sessions | sed -E 's/:.*$//' | grep -v \"^$(tmux display-message -p '#S')\$\" | fzf --reverse | xargs tmux switch-client -t"

# Session switcher using sesh (Ctrl+f or Cmd+Shift+j from ghostty)
bind -n C-f run-shell "sesh connect \"$(
  sesh list --icons | fzf-tmux -p 50%,30% \
    --no-sort --reverse --ansi --border-label ' sesh ' --prompt '  ' \
    --bind 'tab:down,btab:up' \
    --bind 'ctrl-f:change-prompt(ðŸ”Ž  )+reload(fd -H -d 2 -t d -E .Trash . ~)' \
    --bind 'ctrl-x:execute(tmux kill-session -t {2..})+change-prompt(âš¡  )+reload(sesh list --icons)' \
    --preview-window 'right:35%' \
    --preview ''
)\""

bind -n M-J run-shell "sesh connect \"$(
  sesh list --icons | fzf-tmux -p 50%,30% \
    --no-sort --reverse --ansi --border-label ' sesh ' --prompt '  ' \
    --bind 'tab:down,btab:up' \
    --bind 'ctrl-f:change-prompt(ðŸ”Ž  )+reload(fd -H -d 2 -t d -E .Trash . ~)' \
    --bind 'ctrl-x:execute(tmux kill-session -t {2..})+change-prompt(âš¡  )+reload(sesh list --icons)' \
    --preview-window 'right:35%' \
    --preview ''
)\""

# Mouse interactions with session name in status bar
bind-key -n MouseUp1StatusLeft switch-client -n
bind-key -n WheelDownStatusLeft switch-client -n
bind-key -n WheelUpStatusLeft switch-client -p

# ============================================================================
# PLUGIN MANAGER (must be at the end)
# ============================================================================

# Initialize TPM - keep this at the very bottom
run '~/.config/tmux/plugins/tpm/tpm'

